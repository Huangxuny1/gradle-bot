/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package org.gradle.bot

import com.fasterxml.jackson.databind.ObjectMapper
import com.google.inject.AbstractModule
import com.google.inject.Guice
import com.google.inject.Injector
import io.vertx.core.AbstractVerticle
import io.vertx.core.Promise
import io.vertx.core.Verticle
import io.vertx.core.Vertx
import io.vertx.core.http.HttpServerResponse
import io.vertx.core.json.Json
import io.vertx.core.spi.VerticleFactory
import io.vertx.ext.web.Router
import io.vertx.ext.web.handler.BodyHandler
import io.vertx.kotlin.core.http.httpServerOptionsOf
import org.gradle.bot.client.GitHubClient
import org.gradle.bot.handler.GitHubWebHookHandler
import org.gradle.bot.handler.TeamCityWebHookHandler
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import java.util.concurrent.Callable
import javax.inject.Inject

val objectMapper: ObjectMapper = ObjectMapper()
val logger: Logger = LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME)

fun main() {
    val vertx = Vertx.vertx()
    val injector = Guice.createInjector(GradleBotAppModule(vertx))
    vertx.exceptionHandler { logger.error("", it) }
    vertx.registerVerticleFactory(GuiceVerticleFactory(injector))
    vertx.deployVerticle(MainVerticle::class.java.name)
}

class GuiceVerticleFactory(private val injector: Injector) : VerticleFactory {
    override fun createVerticle(verticleName: String?, classLoader: ClassLoader?, promise: Promise<Callable<Verticle>>?) {
        try {
            promise!!.complete(Callable {
                try {
                    injector.getInstance(MainVerticle::class.java)
                } catch (e: Throwable) {
                    logger.error("", e)
                    throw e
                }
            })
        } catch (e: Throwable) {
            logger.error("", e)
            promise!!.fail(e)
        }
    }

    override fun prefix(): String = MainVerticle::class.java.simpleName
}

class GradleBotAppModule(private val vertx: Vertx) : AbstractModule() {
    override fun configure() {
        bind(Vertx::class.java).toInstance(vertx)
    }
}

class MainVerticle @Inject constructor(private val gitHubWebHookHandler: GitHubWebHookHandler,
                                       private val teamCityWebHookHandler: TeamCityWebHookHandler,
                                       private val gitHubClient: GitHubClient) : AbstractVerticle() {
    private val logger: Logger = LoggerFactory.getLogger(MainVerticle::class.java.name)

    override fun start(startFuture: Promise<Void>) {
        gitHubClient.init().onSuccess {
            logger.info("GitHub client initialized, I am {}", gitHubClient.whoAmI())

            val router = createRouter()

            val serverOptions = httpServerOptionsOf(host = "localhost", port = 8080, ssl = false, compressionSupported = true)
            vertx.createHttpServer(serverOptions)
                    .requestHandler(router)
                    .listen { result ->
                        if (result.succeeded()) {
                            logger.info("App started.")
                            startFuture.complete()
                        } else {
                            startFuture.fail(result.cause())
                        }
                    }
        }
    }

    private fun createRouter() = Router.router(vertx).apply {
        route("/*").handler(BodyHandler.create())
        post("/github").handler(gitHubWebHookHandler)
        post("/teamcity").handler(teamCityWebHookHandler)
        errorHandler(500) { it?.failure()?.printStackTrace() }
    }

    /**
     * Extension to the HTTP response to output JSON objects.
     */

}

fun HttpServerResponse.endWithJson(obj: Any) {
    this.putHeader("Content-Type", "application/json; charset=utf-8").end(Json.encodePrettily(obj))
}
